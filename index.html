<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Syntri • QR Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIrt8jvQpW9N+MGPbY6rY3s6QCG+YtG1vCvtKo1YFpsioeQq9v7bSIL3V7CwKqVdQ0bV1PpL5x1sI6W7Gd2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    if(!window.QRCode){
      var s=document.createElement('script');
      s.src='https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
      document.head.appendChild(s);
    }
  </script>
  <style>
    :root { --bg:#0b0f14; --panel:#111722; --muted:#90a3b3; --text:#e8eef6; --accent:#7dd3fc; --accent-2:#22d3ee; }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f8fb; --panel:#ffffff; --muted:#5b6b78; --text:#0b0f14; --accent:#0284c7; --accent-2:#06b6d4; } }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background: radial-gradient(1200px 500px at 80% -10%, rgba(125,211,252,.15), transparent), var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:48px auto; padding:0 20px; }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:18px; box-shadow:0 10px 32px rgba(0,0,0,.25); overflow:hidden; }
    header{ position:relative; padding:22px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.06); }
    h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.2px; }
    .decor-logo{ position:absolute; right:18px; top:10px; width:96px; opacity:.95; }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:22px; padding:22px; }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:8px; letter-spacing:.2px; }
    input[type="text"], select, input[type="number"], textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:transparent; color:var(--text); outline:none; }
    input::placeholder, textarea::placeholder{ color:#7a8a98; }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.14); background:transparent; color:var(--text); cursor:pointer; padding:12px 14px; border-radius:12px; font-weight:700; }
    .btn-primary{ /* neutral, bez kolorowego gradientu */ background:transparent; }
    .btn-ghost{ background:transparent; }
    .muted{ color:var(--muted); font-size:12px; }
    .preview{ display:flex; align-items:center; justify-content:center; background: repeating-conic-gradient(from 0deg, #0000 0 15deg, rgba(255,255,255,.03) 15deg 30deg); border-radius:14px; min-height:380px; position:relative; }
    .preview:has(canvas), .preview:has(img){ background:#0b0f1420; }
    .qr-box{ padding:16px; background:#fff; border-radius:12px; }
    footer{ padding:16px 22px; display:flex; align-items:center; justify-content:space-between; border-top:1px solid rgba(255,255,255,.06); }
    .left{ display:flex; gap:10px; align-items:center; }
    .kbd{ font:800 11px/1 Inter,sans-serif; border:1px solid rgba(255,255,255,.2); padding:6px 8px; border-radius:8px; color:var(--muted); }
    a.link{ color:var(--accent); text-decoration:none; }

    /* Subnav */
    .subnav{ position:sticky; top:0; z-index:5; background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.15) 100%), var(--panel); border-bottom:1px solid rgba(255,255,255,.06); display:flex; gap:10px; padding:10px 16px; backdrop-filter: blur(6px); }
    .subnav a{ font-size:12px; padding:8px 10px; border-radius:10px; text-decoration:none; color:var(--muted); border:1px solid transparent; }
    .subnav a.active{ color:var(--text); border-color: rgba(255,255,255,.14); }
    html{ scroll-behavior:smooth; }

    /* Cinematic overlay */
    .syntri-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:#000a;backdrop-filter:blur(6px);opacity:0;transition:opacity .25s ease;}
    .syntri-modal{width:min(720px,92vw);background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:24px; text-align:center; position:relative;}
    .syntri-title{font-weight:800;letter-spacing:.12em;margin:4px 0 8px 0; display:none;}
    .syntri-sub{margin:0 0 12px 0;font-weight:700;letter-spacing:.25em; display:none;}
    .syntri-grid{display:grid;grid-template-columns:1fr;gap:14px;place-items:center;margin-top:8px;}
    #cin-canvas{background:transparent;border-radius:12px;padding:12px;}
    .syntri-actions{display:flex;gap:10px;justify-content:center;margin-top:8px; display:none;}
    .syntri-actions .btn[disabled]{opacity:.5;pointer-events:none;}
    .syntri-close{position:absolute;right:16px;top:12px;cursor:pointer;font-weight:700;color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <!-- usunięto gears i badge; logo w prawym górnym rogu -->
        <img class="decor-logo" src="assets/syntri_logo_black.png" alt="Syntri logo"/>
        <h1 id="title" data-i18n="title">Syntri • QR Generator</h1>
        <!-- language przeniesiony do Options -->
      </header>

      <nav class="subnav" aria-label="Section navigation">
        <a href="#sec-input" id="nav-input">Input</a>
        <a href="#sec-options" id="nav-options">Options</a>
        <a href="#sec-preview" id="nav-preview">Preview</a>
      </nav>

      <div class="grid">
        <!-- INPUT -->
        <section id="sec-input">
          <div class="field">
            <label for="text" id="label-text" data-i18n="label_text">Treść (URL / tekst)</label>
            <textarea id="text" placeholder="https://syntri.app/qr-generator">https://syntri.app/qr-generator</textarea>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px;">
            <button id="generate" class="btn btn-primary" data-i18n="btn_generate">Generuj (Enter)</button>
            <button id="clear" class="btn btn-ghost" data-i18n="btn_clear">Wyczyść</button>
          </div>
          <p class="muted" id="note-offline" style="margin-top:10px;" data-i18n="note_offline">Działa lokalnie w przeglądarce – żadne dane nie opuszczają urządzenia.</p>
        </section>

        <!-- OPTIONS (z językiem) -->
        <section id="sec-options">
          <div class="row">
            <div>
              <label for="size" id="label-size" data-i18n="label_size">Rozmiar (px)</label>
              <input id="size" type="number" min="64" max="2048" step="16" value="100" />
            </div>
            <div>
              <label for="margin" id="label-margin" data-i18n="label_margin">Margines</label>
              <input id="margin" type="number" min="0" max="16" step="1" value="2" />
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <div>
              <label for="ecc" id="label-ecc" data-i18n="label_ecc">Korekcja błędów</label>
              <select id="ecc">
                <option value="L">L (7%)</option>
                <option value="M" selected>M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H">H (30%)</option>
              </select>
            </div>
            <div>
              <label style="display:block;" data-i18n="label_transparent">Przezroczyste tło</label>
              <label style="display:flex;align-items:center;gap:8px;">
                <input id="transparent" type="checkbox"> <span class="muted">ON/OFF</span>
              </label>
            </div>
          </div>

          <!-- Language switcher w Options -->
          <div style="margin-top:14px;">
            <label data-i18n="label_language">Język</label>
            <div class="lang-switch">
              <button type="button" class="btn btn-ghost" id="btn-pl">PL</button>
              <button type="button" class="btn btn-ghost" id="btn-en">EN</button>
            </div>
          </div>
        </section>

        <!-- PREVIEW -->
        <section id="sec-preview">
          <div class="preview">
            <div id="qr" class="qr-box"></div>
          </div>
        </section>
      </div>

      <footer>
        <div class="left">
          <span class="kbd">⌘ / Ctrl</span><span class="kbd">Enter</span>
          <span class="muted" id="hint-hotkey" data-i18n="hint_hotkey">— szybkie generowanie</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <a class="link" href="#" id="shareLink" data-i18n="link_share" title="Udostępnij parametry w URL">Udostępnij</a>
          <button id="copyLink" class="btn btn-ghost" data-i18n="btn_copy">Kopiuj link</button>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // --- helpers
    const $ = (s) => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    const persist = (k,v) => localStorage.setItem(`syntri.qr.${k}`, v);
    const load = (k, def) => localStorage.getItem(`syntri.qr.${k}`) ?? def;

    // refs
    const text = $('#text'); const size=$('#size'); const ecc=$('#ecc');
    const margin=$('#margin'); const transparent=$('#transparent'); const qrBox=$('#qr');

    let qr; // qrcodejs instance
    let cinOpen = false;

    // --- core
    function clamp(n, min, max){ return Math.min(Math.max(n, min), max); }
    function filename(ext){
      const raw = text.value.trim() || 'syntri';
      const slug = raw.replace(/^https?:\\/\\//,'').slice(0,64).replace(/[^a-z0-9\\-_.]+/gi,'-').replace(/-+/g,'-').replace(/(^-|-$)/g,'');
      return `syntri-qr-${slug || 'code'}.${ext}`;
    }

    function render(){
      qrBox.innerHTML = '';
      const value = text.value.trim() || 'https://syntri.app/qr-generator';
      const colorDark = '#000000'; // stały czarny
      const colorLight = transparent?.checked ? 'rgba(0,0,0,0)' : '#ffffff';
      const width = clamp(parseInt(size.value||100,10), 64, 2048);
      const m = clamp(parseInt(margin.value||2,10), 0, 16);

      qr = new QRCode(qrBox, {
        text: value, width, height: width,
        colorDark, colorLight,
        correctLevel: QRCode.CorrectLevel[ecc.value || 'M'],
        margin: m
      });

      qrBox.setAttribute('role','img');
      qrBox.setAttribute('aria-label', `QR code, size ${width}px, ECC ${ecc.value}, margin ${m}`);
    }

    // --- downloads from modal canvas
    function downloadCanvasAsPNG(canvas, name){
      const scale = 2;
      const off = document.createElement('canvas');
      off.width = canvas.width*scale; off.height = canvas.height*scale;
      const ctx = off.getContext('2d');
      if(!transparent.checked){ ctx.fillStyle = '#fff'; ctx.fillRect(0,0,off.width,off.height); }
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(canvas, 0, 0, off.width, off.height);
      const a = document.createElement('a'); a.download = name; a.href = off.toDataURL('image/png'); a.click();
    }
    function downloadCanvasAsSVG(canvas, name, transparentBg){
      const pngData = canvas.toDataURL('image/png');
      const bg = transparentBg ? '' : '<rect width="100%" height="100%" fill="#fff"/>';
      const svg = `<?xml version="1.0" encoding="UTF-8"?>\\n<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">${bg}<image href="${pngData}" width="100%" height="100%"/></svg>`;
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    // --- state sync
    function syncFromURL(){
      if(params.has('t')) text.value = decodeURIComponent(params.get('t'));
      if(params.has('s')) size.value = params.get('s');
      if(params.has('e')) ecc.value = params.get('e');
      if(params.has('m')) margin.value = params.get('m');
      if(params.has('bg')) transparent.checked = params.get('bg') === '1';
      // kolor usunięty – ignorujemy ewentualne 'c'
    }
    function restoreState(){
      if(!params.has('t')) text.value   = load('t', text.value);
      if(!params.has('s')) size.value   = load('s', size.value);
      if(!params.has('e')) ecc.value    = load('e', ecc.value);
      if(!params.has('m')) margin.value = load('m', margin.value);
      if(!params.has('bg')) transparent.checked = (load('bg','0')==='1');
    }
    function saveState(){
      persist('t', text.value.trim()); persist('s', size.value);
      persist('e', ecc.value); persist('m', margin.value);
      persist('bg', transparent.checked ? '1':'0');
    }
    function updateShareLink(){
      const p = new URLSearchParams({ t:text.value.trim(), s:size.value, e:ecc.value, m:margin.value, bg: transparent.checked ? '1':'0' });
      const base = (location.origin && location.origin!=='null') ? (location.origin + location.pathname) : location.pathname;
      const url = base + '?' + p.toString();
      $('#shareLink').href = url;
      $('#copyLink').onclick = async ()=>{ try{ await navigator.clipboard.writeText(url); console.log('copied'); }catch{} };
    }

    // --- live events
    function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    const liveRender = debounce(()=>{ render(); updateShareLink(); saveState(); }, 250);
    ['input','change'].forEach(ev=>{
      on(text, ev, liveRender); on(size, ev, liveRender); on(ecc, ev, liveRender);
      on(margin, ev, liveRender); on(transparent, ev, liveRender);
    });

    // GENERUJ → preview + modal z animacją
    $('#generate').addEventListener('click', () => { render(); updateShareLink(); saveState(); startCinematic(); });
    $('#clear').addEventListener('click', () => { text.value=''; render(); updateShareLink(); saveState(); });
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){ render(); updateShareLink(); saveState(); startCinematic(); } });

    // init
    (function initWhenReady(){
      const start = Date.now();
      (function check(){
        if (window.QRCode) { syncFromURL(); restoreState(); render(); updateShareLink(); }
        else if (Date.now() - start < 8000) setTimeout(check, 50);
        else { console.error('QRCode library failed to load'); alert('QR library failed to load. Please refresh (Ctrl/Cmd+F5).'); }
      })();
    })();

    // --- modal z animacją 5s
    function startCinematic(){
      if (cinOpen) return; cinOpen = true;
      if(!qr || !qr._oQRCode){ render(); }
      if(!qr || !qr._oQRCode){ alert(i18n('alert_generate_first')); cinOpen=false; return; }

      const q = qr._oQRCode;
      const modules = q.moduleCount;
      const matrix  = q.modules || [];
      const cell = 10;
      const marginCells = clamp(parseInt(margin.value||2,10), 0, 16);
      const quietPx = marginCells * cell;
      const canvasSize = (modules + marginCells*2) * cell;

      const dark = [];
      for (let y = 0; y < modules; y++){
        for (let x = 0; x < modules; x++){
          if (matrix[y] && matrix[y][x]) dark.push([x,y]);
        }
      }
      for (let i=dark.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [dark[i],dark[j]] = [dark[j],dark[i]]; }

      const overlay = document.createElement('div'); overlay.className='syntri-overlay';
      const modal = document.createElement('div'); modal.className='syntri-modal';
      const closeBtn = document.createElement('div'); closeBtn.className='syntri-close'; closeBtn.textContent = i18n('btn_close');
      closeBtn.onclick = ()=>{ overlay.style.opacity='0'; setTimeout(()=>{ overlay.remove(); cinOpen=false; },200); };

      const title = document.createElement('h2'); title.className='syntri-title'; title.textContent = i18n('modal_title');
      const sub   = document.createElement('div'); sub.className='syntri-sub'; sub.textContent = i18n('modal_sub');
      const grid  = document.createElement('div'); grid.className='syntri-grid';
      const hint  = document.createElement('div'); hint.className='muted'; hint.id='cin-hint'; hint.textContent = i18n('modal_hint');

      const cv = document.createElement('canvas'); cv.id='cin-canvas'; cv.width=canvasSize; cv.height=canvasSize;
      const ctx = cv.getContext('2d', { alpha: true });
      if (!transparent?.checked){ ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cv.width,cv.height); }

      const actions = document.createElement('div'); actions.className='syntri-actions';
      const btnPng = document.createElement('button'); btnPng.className='btn btn-ghost'; btnPng.textContent = i18n('btn_png'); btnPng.disabled = true;
      const btnSvg = document.createElement('button'); btnSvg.className='btn btn-ghost'; btnSvg.textContent = i18n('btn_svg'); btnSvg.disabled = true;
      actions.appendChild(btnPng); actions.appendChild(btnSvg);

      grid.appendChild(cv);
      modal.appendChild(closeBtn);
      modal.appendChild(title); modal.appendChild(sub);
      modal.appendChild(grid);
      modal.appendChild(actions);
      modal.appendChild(hint);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      requestAnimationFrame(()=>{ overlay.style.opacity='1'; });

      const totalMs = 5000;
      const t0 = performance.now();
      const N = dark.length;
      const fgColor = '#000000'; // stały czarny
      let lastDrawn = 0;

      if (N === 0){
        // brak pikseli → pokaż finalny UI natychmiast
        document.querySelectorAll('.syntri-title,.syntri-sub,.syntri-actions').forEach(el=>{ el.style.display='block'; });
        btnPng.disabled = btnSvg.disabled = false;
        btnPng.onclick = ()=> downloadCanvasAsPNG(cv, filename('png'));
        btnSvg.onclick = ()=> downloadCanvasAsSVG(cv, filename('svg'), transparent?.checked);
        hint.textContent = '';
        return;
      }

      function frame(now){
        const elapsed = Math.max(0, now - t0);
        const t = Math.min(1, elapsed / totalMs);
        const shouldDraw = Math.floor(N * t);

        ctx.fillStyle = fgColor;
        for (let i = lastDrawn; i < shouldDraw; i++){
          const [x,y] = dark[i];
          ctx.fillRect(quietPx + x*cell, quietPx + y*cell, cell, cell);
        }
        lastDrawn = shouldDraw;

        hint.textContent = (t < 1) ? `${i18n('modal_hint')} ${Math.round(t*100)}%` : '';

        if (t < 1){
          requestAnimationFrame(frame);
        } else {
          document.querySelectorAll('.syntri-title,.syntri-sub,.syntri-actions').forEach(el=>{ el.style.display='block'; });
          btnPng.disabled = btnSvg.disabled = false;
          btnPng.onclick = ()=> downloadCanvasAsPNG(cv, filename('png'));
          btnSvg.onclick = ()=> downloadCanvasAsSVG(cv, filename('svg'), transparent?.checked);
          hint.textContent = '';
        }
      }
      requestAnimationFrame(frame);
    }

    // --- subnav active
    const NAV_LINKS = [
      { id: 'nav-input',   sec: 'sec-input' },
      { id: 'nav-options', sec: 'sec-options' },
      { id: 'nav-preview', sec: 'sec-preview' },
    ];
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        const s = NAV_LINKS.find(x=>x.sec===e.target.id);
        if(!s) return;
        const link = document.getElementById(s.id);
        if (link) link.classList.toggle('active', e.isIntersecting && e.intersectionRatio>0.5);
      });
    }, {root:null, rootMargin:'-20% 0px -60% 0px', threshold:[0.5]});
    ['sec-input','sec-options','sec-preview'].forEach(id=>{ const n=document.getElementById(id); if(n) io.observe(n); });

    // --- i18n
    const I18N = {
      pl: {
        title: 'Syntri • Generator QR',
        label_text: 'Treść (URL / tekst)',
        label_size: 'Rozmiar (px)',
        label_ecc: 'Korekcja błędów',
        label_margin: 'Margines',
        label_transparent: 'Przezroczyste tło',
        label_language: 'Język',
        btn_generate: 'Generuj (Enter)',
        btn_clear: 'Wyczyść',
        btn_png: 'Pobierz PNG',
        btn_svg: 'Pobierz SVG',
        btn_copy: 'Kopiuj link',
        btn_close: 'Zamknij',
        link_share: 'Udostępnij',
        note_offline: 'Działa lokalnie w przeglądarce – żadne dane nie opuszczają urządzenia.',
        hint_hotkey: '— szybkie generowanie',
        alert_generate_first: 'Najpierw wygeneruj QR',
        copied: 'Skopiowano',
        modal_title: 'Its your qr code',
        modal_sub: 'Generator by Syntri',
        modal_hint: 'Budowanie pikseli…'
      },
      en: {
        title: 'Syntri • QR Generator',
        label_text: 'Content (URL / text)',
        label_size: 'Size (px)',
        label_ecc: 'Error correction',
        label_margin: 'Margin',
        label_transparent: 'Transparent background',
        label_language: 'Language',
        btn_generate: 'Generate (Enter)',
        btn_clear: 'Clear',
        btn_png: 'Download PNG',
        btn_svg: 'Download SVG',
        btn_copy: 'Copy link',
        btn_close: 'Close',
        link_share: 'Share',
        note_offline: 'Runs locally in your browser — no data leaves your device.',
        hint_hotkey: '— quick generate',
        alert_generate_first: 'Generate the QR first',
        copied: 'Copied',
        modal_title: 'Its your qr code',
        modal_sub: 'Generator by Syntri',
        modal_hint: 'Building pixels…'
      }
    };
    function i18n(k){ const lang = localStorage.getItem('syntri.lang') || 'pl'; return (I18N[lang]||I18N.en)[k] || k; }
    const userLang = localStorage.getItem('syntri.lang') || ((navigator.language || 'en').startsWith('pl') ? 'pl' : 'en');
    function applyI18n(lang){
      const dict = I18N[lang] || I18N.en;
      document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (dict[key]) el.textContent = dict[key]; });
      const textInput = document.getElementById('text'); if (textInput && textInput.placeholder) textInput.placeholder = lang==='pl' ? 'https://syntri.app/qr-generator' : 'https://syntri.app/qr-generator';
      localStorage.setItem('syntri.lang', lang);
    }
    document.getElementById('btn-pl')?.addEventListener('click', ()=>{ applyI18n('pl'); });
    document.getElementById('btn-en')?.addEventListener('click', ()=>{ applyI18n('en'); });
    applyI18n(userLang);
  </script>
</body>
</html>
