<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIrt8jvQpW9N+MGPbY6rY3s6QCG+YtG1vCvtKo1YFpsioeQq9v7bSIL3V7CwKqVdQ0bV1PpL5x1sI6W7Gd2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    if(!window.QRCode){
      var s=document.createElement('script');
      s.src='https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js';
      document.head.appendChild(s);
    }
  </script>

  <style>
    :root{--bg:#0b0f14;--panel:#111722;--muted:#90a3b3;--text:#e8eef6;--accent:#7dd3fc;--accent-2:#22d3ee;}
    @media (prefers-color-scheme: light){:root{--bg:#f6f8fb;--panel:#ffffff;--muted:#5b6b78;--text:#0b0f14;--accent:#0284c7;--accent-2:#06b6d4}}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:radial-gradient(1200px 500px at 80% -10%, rgba(125,211,252,.15), transparent),var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:48px auto;padding:0 20px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:0 10px 32px rgba(0,0,0,.25);overflow:hidden}
    header{position:relative;padding:22px 24px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid rgba(255,255,255,.06)}
    .decor-logo{position:absolute;right:12px;top:2px;width:72px;opacity:.95}
    .page-title{margin:0;width:100%;text-align:center;font-size:20px;font-weight:800;letter-spacing:.2px;pointer-events:none}
    .subnav{position:sticky;top:0;z-index:5;background:linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.15) 100%),var(--panel);border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:10px;padding:10px 16px;backdrop-filter:blur(6px)}
    .subnav a{font-size:12px;padding:8px 10px;border-radius:10px;text-decoration:none;color:var(--muted);border:1px solid transparent}
    .subnav a.active{color:var(--text);border-color:rgba(255,255,255,.14)}
    .lang-panel{display:none;gap:8px;padding:10px 16px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,.06)}
    .lang-panel.show{display:flex}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px;padding:22px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px;letter-spacing:.2px}
    input[type="text"],textarea,select,input[type="number"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);outline:none}
    input::placeholder{color:#7a8a98}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:12px;font-weight:700}
    .btn-primary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14)}
    .btn-primary:hover{background:rgba(255,255,255,.06)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14)}
    .muted{color:var(--muted);font-size:12px}
    .preview{display:flex;align-items:center;justify-content:center;background:repeating-conic-gradient(from 0deg,#0000 0 15deg,rgba(255,255,255,.03) 15deg 30deg);border-radius:14px;min-height:380px;position:relative}
    .preview:has(canvas),.preview:has(img){background:#0b0f1420}
    .qr-box{padding:16px;background:#fff;border-radius:12px}
    footer{padding:16px 22px;display:flex;align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,.06)}
    .left{display:flex;gap:10px;align-items:center}
    .kbd{font:800 11px/1 Inter,sans-serif;border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:8px;color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}
    .usage-pill{margin-left:8px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted)}
    html{scroll-behavior:smooth}

    /* Cinematic overlay */
    .syntri-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:#000a;backdrop-filter:blur(6px);opacity:0;transition:opacity .25s ease}
    .syntri-modal{width:min(720px,92vw);background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:24px;text-align:center;position:relative}
    .syntri-title{font-weight:800;letter-spacing:.12em;margin:4px 0 8px 0;display:none}
    .syntri-sub{margin:0 0 12px 0;font-weight:700;letter-spacing:.25em;display:none}
    .syntri-grid{display:grid;grid-template-columns:1fr;gap:14px;place-items:center;margin-top:8px}
    #cin-canvas{background:#fff;border-radius:12px;padding:12px}
    .syntri-actions{display:flex;gap:10px;justify-content:center;margin-top:8px;display:none}
    .syntri-actions .btn[disabled]{opacity:.5;pointer-events:none}
    .syntri-close{position:absolute;right:16px;top:12px;cursor:pointer;font-weight:700;color:var(--muted)}

    /* Generic modal for Login/Account/Paywall */
    .modal{position:fixed;inset:0;z-index:9998;display:none;align-items:center;justify-content:center;background:#000a;backdrop-filter:blur(4px)}
    .modal.show{display:flex}
    .modal-card{width:min(520px,92vw);background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.45);padding:20px}
    .modal-card h3{margin:0 0 8px 0;font-size:16px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .field-row{display:flex;flex-direction:column;gap:6px;margin-top:8px}

    /* === Syntri UI – Login Card override === */
#loginModal .modal-card{
  width:min(520px,92vw);
  background:#fff; color:#111827;
  border:1px solid #e5e7eb; border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
  padding:24px 28px;
}
@media (prefers-color-scheme: dark){
  #loginModal .modal-card{
    background:#0f1720; color:#e5e7eb;
    border-color:#1f2937; box-shadow:0 6px 20px rgba(0,0,0,.35);
  }
}
#loginModal .modal-card h3{
  margin:0 0 6px; font-weight:600; font-size:1.4rem; text-align:center;
}
#loginModal .field-row label{
  font-size:.95rem; color:#111827;
}
@media (prefers-color-scheme: dark){
  #loginModal .field-row label{ color:#e5e7eb; }
}
#loginModal input[type="email"],
#loginModal input[type="password"]{
  width:100%; padding:10px 12px; margin-top:6px;
  font-size:1rem; border-radius:8px; box-sizing:border-box;
  background:transparent; outline:none;
  border:1px solid #d1d5db; color:#111827;
}
@media (prefers-color-scheme: dark){
  #loginModal input[type="email"],
  #loginModal input[type="password"]{
    border-color:#334155; color:#e5e7eb;
  }
}
#loginModal .btn-primary{
  background:#111827; color:#fff; border:0;
  border-radius:8px; padding:12px 16px; font-weight:600; font-size:1rem;
  transition:background .15s ease, transform .02s ease-in;
}
#loginModal .btn-primary:hover{ background:#1f2937; }
#loginModal .btn-primary:active{ transform:translateY(1px); }
@media (prefers-color-scheme: dark){
  #loginModal .btn-primary{
    background:#e5e7eb; color:#111827;
  }
  #loginModal .btn-primary:hover{ background:#d1d5db; }
}
#loginModal .btn-ghost{
  background:transparent; color:inherit;
  border:1px solid rgba(0,0,0,.12);
  border-radius:8px; padding:10px 14px; font-weight:600;
}
@media (prefers-color-scheme: dark){
  #loginModal .btn-ghost{ border-color:#334155; }
}

    
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img class="decor-logo" src="assets/syntri_logo_black.png" alt="Syntri logo"/>
        <h1 id="title" class="page-title" data-i18n="title">Syntri • QR Generator</h1>
      </header>

      <!-- Simplified nav: Login / Language -->
      <nav class="subnav" aria-label="App navigation">
        <a href="#" id="nav-login" data-i18n="nav_login">Login</a>
        <a href="#" id="nav-account" style="display:none" data-i18n="nav_account">Account</a>
        <a href="#" id="nav-settings" style="display:none" data-i18n="nav_settings">Settings</a>
        <a href="#" id="nav-signout" style="display:none" data-i18n="nav_signout">Sign out</a>
        <a href="#" id="nav-language" data-i18n="nav_language" style="margin-left:auto">Language</a>
      </nav>
      <div id="lang-panel" class="lang-panel" aria-hidden="true">
        <button type="button" class="btn btn-ghost" id="btn-pl">PL</button>
        <button type="button" class="btn btn-ghost" id="btn-en">EN</button>
      </div>

      <!-- Single section: Input + compact options + preview -->
      <div class="grid">
        <section>
          <div class="field">
            <label for="text" id="label-text" data-i18n="label_text">Treść (URL / tekst)</label>
            <input id="text" type="text" placeholder="https://syntriagency.github.io/syntri-qr-generator/" value="https://syntri.app" />
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label for="size" id="label-size" data-i18n="label_size">Rozmiar (px)</label>
              <input id="size" type="number" min="64" max="2048" step="16" value="100" />
            </div>
            <div>
              <label for="margin" id="label-margin" data-i18n="label_margin">Margines</label>
              <input id="margin" type="number" min="0" max="16" step="1" value="2" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label for="ecc" id="label-ecc" data-i18n="label_ecc">Korekcja błędów</label>
              <select id="ecc">
                <option value="L">L (7%)</option>
                <option value="M" selected>M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H">H (30%)</option>
              </select>
            </div>
            <div>
              <label for="fg" id="label-color" data-i18n="label_color">Kolor kodu</label>
              <input id="fg" type="color" value="#000000" />
            </div>
          </div>

          <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
            <input id="transparent" type="checkbox"> <span class="muted" data-i18n="label_transparent">Przezroczyste tło</span>
          </label>

          <div style="display:flex; gap:10px; align-items:center; margin-top:16px;">
            <button id="generate" class="btn btn-primary" data-i18n="btn_generate">Generuj</button>
            <button id="clear" class="btn btn-ghost" data-i18n="btn_clear">Wyczyść</button>
            <span id="usagePill" class="usage-pill" title="Free monthly quota">10 / 10</span>
          </div>

<!-- DEV panel – widoczny tylko z ?dev=1 -->
<div id="dev-panel" style="display:none; margin-top:8px; display:flex; gap:8px;">
  <button id="dev-exhaust" class="btn btn-ghost">DEV: Max limit</button>
  <button id="dev-reset"   class="btn btn-ghost">DEV: Reset</button>
</div>
          
          <p class="muted" id="note-offline" style="margin-top:10px;" data-i18n="note_offline">
            Działa lokalnie w przeglądarce — żadne dane nie opuszczają urządzenia.
          </p>
        </section>

        <section id="sec-preview">
          <div class="preview">
            <div id="qr" class="qr-box"></div>
          </div>
        </section>
      </div>

      <footer>
        <div class="left">
          <span class="kbd">⌘ / Ctrl + Enter</span>
          <span class="muted" id="hint-hotkey" data-i18n="hint_hotkey">— szybkie generowanie</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <a class="link" href="#" id="shareLink" data-i18n="link_share" title="Udostępnij parametry w URL">Udostępnij</a>
          <button id="copyLink" class="btn btn-ghost" data-i18n="btn_copy">Kopiuj link</button>
        </div>
      </footer>
    </div>
  </div>

 <!-- Login / Register modal (Email + Password) -->
<div id="loginModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3 data-i18n="login_title">Account</h3>

    <div class="field-row">
      <label for="loginEmail" class="muted" data-i18n="login_email_label">Email</label>
      <input id="loginEmail" type="email" placeholder="you@domain.com"
             required autocomplete="email" inputmode="email" />
    </div>

    <div class="field-row">
      <label for="loginPass" class="muted">Hasło</label>
      <input id="loginPass" type="password" placeholder="min. 6 znaków"
             required autocomplete="current-password" />
    </div>

    <div class="field-row" style="margin-top:12px;display:flex;gap:8px;">
      <button id="btnRegister" class="btn btn-primary" type="button">Zarejestruj</button>
      <button id="btnLogin"    class="btn btn-ghost"   type="button">Zaloguj</button>
      <button id="btnForgot"   class="btn btn-ghost"   type="button">Forgot password?</button>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" id="loginCancel" data-i18n="btn_cancel" type="button">Cancel</button>
    </div>
  </div>
</div>

  <!-- Account modal -->
  <div id="accountModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 data-i18n="account_title">Account</h3>
      <p class="muted" id="accountEmail"></p>
      <p class="muted" id="accountPlan"></p>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="openPortal" data-i18n="btn_manage_billing">Manage billing</button>
        <button class="btn btn-primary" id="accountClose" data-i18n="btn_close">Close</button>
      </div>
    </div>
  </div>

<!-- Account modal -->
  <div id="accountModal" class="modal" aria-hidden="true">
    …
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>Settings</h3>

      <div class="field-row">
        <label>Email</label>
        <p id="settingsEmail" class="muted"></p>
      </div>

      <div class="field-row">
        <label>Plan</label>
        <p id="settingsPlan" class="muted"></p>
      </div>

      <div class="modal-actions" style="justify-content:space-between;margin-top:16px;">
        <button id="deleteAccount" class="btn btn-ghost">Delete account</button>
        <button id="settingsClose"  class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Paywall modal -->
  <div id="paywallModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 data-i18n="paywall_title">Free limit reached</h3>
      <p class="muted" data-i18n="paywall_copy">You used all free codes this month. Choose a plan to continue.</p>
      <div class="modal-actions" style="justify-content:space-between">
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" id="subscribeStripe">Subscribe – Stripe</button>
          <button class="btn btn-ghost" id="subscribePayPal">Subscribe – PayPal</button>
        </div>
        <button class="btn btn-ghost" id="paywallClose" data-i18n="btn_close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------
    // helpers / state
    // ----------------------------------------------
    const $ = (s) => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    const persist = (k,v) => localStorage.setItem(`syntri.qr.${k}`, v);
    const load = (k, def) => localStorage.getItem(`syntri.qr.${k}`) ?? def;

    const text = $('#text'); const size=$('#size'); const ecc=$('#ecc');
    const margin=$('#margin'); const fg=$('#fg'); const transparent=$('#transparent');
    const qrBox=$('#qr'); const usagePill = $('#usagePill');


    
    let qr;

   // --- metrics (stub) ---
   // Podmień na wywołanie Firestore, gdy podepniesz Firebase.
   async function bumpQrCount(){
   if (!AUTH.isLoggedIn()) return;          // Zliczaj tylko zalogowanych
   // TODO: Firestore: increment(qrCount) dla bieżącego użytkownika
     console.debug('bumpQrCount (mock) – zalogowany:', AUTH.email());
   }
    
    function clamp(n, min, max){ return Math.min(Math.max(n, min), max); }
    function filename(ext){
      const raw = text.value.trim() || 'syntri';
      const slug = raw.replace(/^https?:\/\//,'').slice(0,64).replace(/[^a-z0-9\-_.]+/gi,'-').replace(/-+/g,'-').replace(/(^-|-$)/g,'');
      return `syntri-qr-${slug || 'code'}.${ext}`;
    }

    // ----------------------------------------------
    // Auth (mock) – podmień na Firebase Auth
    // ----------------------------------------------
    const AUTH = {
      isLoggedIn: () => !!localStorage.getItem('syntri.auth.uid'),
      email:      () => localStorage.getItem('syntri.auth.email') || '',
      loginMock(email){
        localStorage.setItem('syntri.auth.uid','dev_uid');
        localStorage.setItem('syntri.auth.email', email || 'user@example.com');
        renderAuthUI();
      },
      logout(){
        localStorage.removeItem('syntri.auth.uid');
        localStorage.removeItem('syntri.auth.email');
        renderAuthUI();
      }
    };

    function renderAuthUI(){
      const logged = AUTH.isLoggedIn();
      $('#nav-login').style.display   = logged ? 'none' : 'inline-block';
      $('#nav-account').style.display = logged ? 'inline-block' : 'none';
      $('#nav-settings').style.display = logged ? 'inline-block' : 'none';
      $('#nav-signout').style.display = logged ? 'inline-block' : 'none';
      // logged → liczenie usage na serwerze (tu: unlimited until backend)
      renderUsagePill();
      ensureHomeGate();  
    }

    // ----------------------------------------------
// Usage & Plans (front-gate for anon + logged)
// ----------------------------------------------

// Plan (mock). Na razie trzymany w localStorage; gdy podepniesz backend, zwracaj realny plan.
// Ustaw ręcznie w konsoli np.: localStorage.setItem('syntri.plan','Free'|'Basic'|'Pro')
function getPlan(){
  return AUTH.isLoggedIn() ? (localStorage.getItem('syntri.plan') || 'Free') : 'Free';
}

// Reset miesięczny: 1. dzień następnego miesiąca, 00:00
function monthResetAtMs(){
  const d = new Date();
  const y = d.getFullYear(), m = d.getMonth();
  return new Date(y, m + 1, 1, 0, 0, 0, 0).getTime();
}

function usageKey(){
  const d=new Date();
  const ym=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
  return `syntri.qr.usage.${ym}`;
}

// Quoty per plan
function planQuota(plan){
  if (plan === 'Pro') return Infinity;
  if (plan === 'Basic') return 100;
  return 15; // Free
}

// Zwraca {used, quota, resetAt}
function getUsage(){
  const plan = getPlan();
  const quota = planQuota(plan);
  const resetAt = monthResetAtMs();
  const def = { used:0, quota, resetAt };

  try {
    const raw = JSON.parse(localStorage.getItem(usageKey()) || JSON.stringify(def));
    raw.quota = quota;
    raw.resetAt = resetAt;
    return raw;
  } catch {
    return def;
  }
}

function saveUsage(u){
  // zapisujemy dla wszystkich (anon + logged), by front-gate był spójny
  localStorage.setItem(usageKey(), JSON.stringify(u));
}

function renderUsagePill(){
  const u = getUsage();
  const plan = getPlan();
  const left = (u.quota===Infinity) ? '∞' : Math.max(0, u.quota - u.used);
  usagePill.textContent = (u.quota===Infinity) ? `${plan} • unlimited` : `${left} / ${u.quota}`;
  usagePill.title = (u.quota===Infinity) ? 'Paid plan' : 'Monthly quota';
  ensureHomeGate();
}

// Konsumpcja: { ok, remaining, resetMs }
function tryConsumeUsage(){
  const u = getUsage();
  if (u.quota === Infinity) return { ok:true, remaining:Infinity, resetMs:0 };

  if (u.used >= u.quota){
    const resetMs = Math.max(0, u.resetAt - Date.now());
    return { ok:false, remaining:0, resetMs };
  }
  u.used += 1;
  saveUsage(u);
  renderUsagePill();
  return { ok:true, remaining: u.quota - u.used, resetMs: Math.max(0, u.resetAt - Date.now()) };
}
    // --- helpers: szybkie sprawdzenie limitu na stronie głównej ---
function canGenerateNow(){ 
  const u = getUsage();
  return u.quota === Infinity || u.used < u.quota;
}

function remainingMs(){
  const u = getUsage();
  return u.quota === Infinity ? 0 : Math.max(0, u.resetAt - Date.now());
}

    // ----------------------------------------------
    // QR render
    // ----------------------------------------------
    function render(){
      qrBox.innerHTML = '';
      const placeholderDefault = 'https://syntriagency.github.io/syntri-qr-generator/';
      const value = text.value.trim() || placeholderDefault;
      const colorDark = fg.value || '#000000';
      const colorLight = transparent?.checked ? 'rgba(0,0,0,0)' : '#ffffff';
      const width = clamp(parseInt(size.value||100,10), 64, 2048);
      const m = clamp(parseInt(margin.value||2,10), 0, 16);

      qr = new QRCode(qrBox, {
        text: value, width, height: width,
        colorDark, colorLight,
        correctLevel: QRCode.CorrectLevel[ecc.value || 'M'],
        margin: m
      });

      qrBox.setAttribute('role','img');
      qrBox.setAttribute('aria-label', `QR code, size ${width}px, ECC ${ecc.value}, margin ${m}`);
    }

    // downloads (from animation canvas)
    function downloadCanvasAsPNG(canvas, name){
      const scale = 2;
      const off = document.createElement('canvas');
      off.width = canvas.width*scale; off.height = canvas.height*scale;
      const ctx = off.getContext('2d');
      if(!transparent.checked){ ctx.fillStyle = '#fff'; ctx.fillRect(0,0,off.width,off.height); }
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(canvas, 0, 0, off.width, off.height);
      const a = document.createElement('a'); a.download = name; a.href = off.toDataURL('image/png'); a.click();
    }
    function downloadCanvasAsSVG(canvas, name, transparentBg){
      const pngData = canvas.toDataURL('image/png');
      const bg = transparentBg ? '' : '<rect width="100%" height="100%" fill="#fff"/>';
      const svg = `<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">${bg}<image href="${pngData}" width="100%" height="100%"/></svg>`;
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    // ----------------------------------------------
    // Cinematic modal + usage gate
    // ----------------------------------------------
    function startCinematic(){
      if(!qr || !qr._oQRCode){ render(); }
      if(!qr || !qr._oQRCode){ alert(i18n('alert_generate_first')); return; }

      const q = qr._oQRCode;
      const modules = q.moduleCount;
      const matrix  = q.modules || [];
      const cell = 10;
      const marginCells = clamp(parseInt(margin.value||2,10), 0, 16);
      const quietPx = marginCells * cell;
      const canvasSize = (modules + marginCells*2) * cell;

      const dark = [];
      for (let y = 0; y < modules; y++) for (let x = 0; x < modules; x++) if (matrix[y] && matrix[y][x]) dark.push([x,y]);
      for (let i=dark.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [dark[i],dark[j]] = [dark[j],dark[i]]; }

      const overlay = document.createElement('div'); overlay.className='syntri-overlay';
      const modal = document.createElement('div'); modal.className='syntri-modal';
      const closeBtn = document.createElement('div'); closeBtn.className='syntri-close'; closeBtn.textContent = i18n('btn_close');
      closeBtn.onclick = ()=>{ overlay.style.opacity='0'; setTimeout(()=>overlay.remove(),200); };

      const title = document.createElement('h2'); title.className='syntri-title'; title.textContent = i18n('modal_title');
      const sub   = document.createElement('div'); sub.className='syntri-sub'; sub.textContent = i18n('modal_sub');
      const grid  = document.createElement('div'); grid.className='syntri-grid';
      const hint  = document.createElement('div'); hint.className='muted'; hint.id='cin-hint'; hint.textContent = i18n('modal_hint');

      const cv = document.createElement('canvas'); cv.id='cin-canvas'; cv.width=canvasSize; cv.height=canvasSize;
      const ctx = cv.getContext('2d', { alpha: true });
      if (!$('#transparent')?.checked){ ctx.fillStyle = '#fff'; ctx.fillRect(0,0,cv.width,cv.height); }

      const actions = document.createElement('div'); actions.className='syntri-actions';
      const btnPng = document.createElement('button'); btnPng.className='btn btn-ghost'; btnPng.textContent = i18n('btn_png'); btnPng.disabled = true;
      const btnSvg = document.createElement('button'); btnSvg.className='btn btn-ghost'; btnSvg.textContent = i18n('btn_svg'); btnSvg.disabled = true;
      actions.appendChild(btnPng); actions.appendChild(btnSvg);

      grid.appendChild(cv);
      modal.appendChild(closeBtn); modal.appendChild(title); modal.appendChild(sub);
      modal.appendChild(grid); modal.appendChild(actions); modal.appendChild(hint);
      overlay.appendChild(modal); document.body.appendChild(overlay);
      requestAnimationFrame(()=>{ overlay.style.opacity='1'; });

      const totalMs = 5000;
      const t0 = performance.now();
      const N = dark.length;
      const fgColor = ($('#fg')?.value) || '#000000';
      let lastDrawn = 0;

      function frame(now){
        const elapsed = Math.max(0, now - t0);
        const t = Math.min(1, elapsed / totalMs);
        const shouldDraw = (N === 0) ? 0 : Math.floor(N * t);

        if (N > 0){
          ctx.fillStyle = fgColor;
          for (let i = lastDrawn; i < shouldDraw; i++){
            const [x,y] = dark[i];
            ctx.fillRect(quietPx + x*cell, quietPx + y*cell, cell, cell);
          }
          lastDrawn = shouldDraw;
        }
        const pct = Math.round(t*100);
        hint.textContent = (t < 1) ? `${i18n('modal_hint')} ${pct}%` : '';

        if (t < 1){
          requestAnimationFrame(frame);
        } else {
          // ANIMATION DONE → usage gate
          const gate = tryConsumeUsage();
          if (!gate.ok){
            // paywall
            openModal('#paywallModal');
            // keep buttons disabled
          } else {
            // enable downloads
            document.querySelectorAll('.syntri-title,.syntri-sub,.syntri-actions').forEach(el=>{ el.style.display='block'; });
            btnPng.disabled = false; btnSvg.disabled = false;
            btnPng.onclick = ()=> downloadCanvasAsPNG(cv, filename('png'));
            btnSvg.onclick = ()=> downloadCanvasAsSVG(cv, filename('svg'), $('#transparent')?.checked);
          }
          hint.textContent = '';
        }
      }
      requestAnimationFrame(frame);
    }

// ----------------------------------------------
// Cooldown UI (zamiana preview na odliczanie + CTA)
// ----------------------------------------------
let cooldownTimerId = null;

function formatDHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return { d, h, m, s:sec };
}

function showCooldownUI(resetMs){
  const preview = document.querySelector('#sec-preview .preview');
  if (!preview) return;

  preview.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.style.textAlign='center';
  wrap.style.padding='20px';

  const h = document.createElement('h3');
  h.textContent = i18n('paywall_title') || 'Free limit reached';
  h.style.margin='0 0 6px 0';

  const p = document.createElement('p');
  p.className = 'muted';
  p.style.margin='0 0 12px 0';
  p.textContent = i18n('paywall_copy') || 'You used all free codes this month.';

  const timer = document.createElement('div');
  timer.style.fontWeight='800';
  timer.style.fontSize='18px';
  timer.style.margin='8px 0 12px 0';
  timer.id = 'cooldown-timer';

  const ctaRow = document.createElement('div');
  ctaRow.style.display='flex';
  ctaRow.style.gap='10px';
  ctaRow.style.justifyContent='center';

  const btnUpgrade1 = document.createElement('button');
  btnUpgrade1.className='btn btn-primary';
  btnUpgrade1.textContent='Upgrade – Stripe';
  btnUpgrade1.onclick = ()=> alert('Stripe Checkout (stub). Podmień na realny endpoint.');

  const btnUpgrade2 = document.createElement('button');
  btnUpgrade2.className='btn btn-ghost';
  btnUpgrade2.textContent='Upgrade – PayPal';
  btnUpgrade2.onclick = ()=> alert('PayPal Subscriptions (stub). Podmień na realny endpoint.');

  ctaRow.appendChild(btnUpgrade1);
  ctaRow.appendChild(btnUpgrade2);

  wrap.appendChild(h); wrap.appendChild(p); wrap.appendChild(timer); wrap.appendChild(ctaRow);
  preview.appendChild(wrap);

  if (cooldownTimerId) clearInterval(cooldownTimerId);
  const tick = ()=>{
    const ms = Math.max(0, resetMs - Date.now());
    const {d,h,m,s} = formatDHMS(ms);
    timer.textContent = (d>0 ? `${d}d ` : '') + `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (ms <= 0){
      clearInterval(cooldownTimerId);
      renderUsagePill();
      // przywróć pusty preview z ramką QR
      document.querySelector('#sec-preview .preview').innerHTML = '<div id="qr" class="qr-box"></div>';
      render();
    }
  };
  tick();
  cooldownTimerId = setInterval(tick, 1000);
}
    
function ensureHomeGate(){
  const ok = canGenerateNow();

  // blokada guzika
  const btn = document.querySelector('#generate');
  if (btn) { 
    btn.disabled = !ok; 
    btn.setAttribute('aria-disabled', String(!ok));
    btn.title = ok ? '' : (i18n('paywall_title') || 'Free limit reached'); 
  }

  if (!ok){
    showCooldownUI(Date.now() + remainingMs());
  } else {
    const preview = document.querySelector('#sec-preview .preview');
    if (preview && preview.querySelector('#cooldown-timer')) {
      preview.innerHTML = '<div id="qr" class="qr-box"></div>';
      render();
    }
  }
}   

    // ----------------------------------------------
    // URL state / live events / init
    // ----------------------------------------------
    function updateShareLink(){
      const p = new URLSearchParams({
        t:text.value.trim(), s:size.value, e:ecc.value, m:margin.value, c:fg.value, bg: transparent.checked ? '1':'0'
      });
      const url = location.origin + location.pathname + '?' + p.toString();
      $('#shareLink').href = url;
      $('#copyLink').onclick = async ()=>{ try{ await navigator.clipboard.writeText(url); }catch{} };
    }

    function syncFromURL(){
      if(params.has('t')) text.value = decodeURIComponent(params.get('t'));
      if(params.has('s')) size.value = params.get('s');
      if(params.has('e')) ecc.value = params.get('e');
      if(params.has('m')) margin.value = params.get('m');
      if(params.has('c')) fg.value = params.get('c');
      if(params.has('bg')) transparent.checked = params.get('bg') === '1';
    }
    function restoreState(){
      if(!params.has('t')) text.value   = load('t', text.value);
      if(!params.has('s')) size.value   = load('s', size.value);
      if(!params.has('e')) ecc.value    = load('e', ecc.value);
      if(!params.has('m')) margin.value = load('m', margin.value);
      if(!params.has('c')) fg.value     = load('c', fg.value);
      if(!params.has('bg')) transparent.checked = (load('bg','0')==='1');
    }
    function saveState(){
      persist('t', text.value.trim()); persist('s', size.value);
      persist('e', ecc.value); persist('m', margin.value);
      persist('c', fg.value); persist('bg', transparent.checked ? '1':'0');
    }

    function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    const liveRender = debounce(()=>{ render(); updateShareLink(); saveState(); }, 250);
    ['input','change'].forEach(ev=>{
      [text,size,ecc,margin,fg,transparent].forEach(el=> on(el, ev, liveRender));
    });

    $('#generate').addEventListener('click', async () => {
  render(); updateShareLink(); saveState(); startCinematic();
  try { await bumpQrCount(); console.log("QR count incremented"); } 
  catch (err) { console.error("bumpQrCount error", err); }
});

$('#clear').addEventListener('click', () => {
  text.value=''; render(); updateShareLink(); saveState();
});

document.addEventListener('keydown', async e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='Enter'){
    render(); updateShareLink(); saveState(); startCinematic();
    try { await bumpQrCount(); } 
    catch (err){ console.error(err); }
  }
});
    (function initWhenReady(){
      const start = Date.now();
      (function check(){
        if (window.QRCode) { syncFromURL(); restoreState(); render(); updateShareLink(); renderAuthUI(); ensureHomeGate(); }
        else if (Date.now() - start < 8000) setTimeout(check, 50);
        else { console.error('QRCode library failed to load'); alert('QR library failed to load. Please refresh (Ctrl/Cmd+F5).'); }
      })();
    })();

    // ----------------------------------------------
    // Language panel
    // ----------------------------------------------
    const navLanguage = document.getElementById('nav-language');
    const langPanel   = document.getElementById('lang-panel');
    navLanguage?.addEventListener('click', (e)=>{
      e.preventDefault();
      const show = !langPanel.classList.contains('show');
      langPanel.classList.toggle('show', show);
      langPanel.setAttribute('aria-hidden', show ? 'false' : 'true');
      navLanguage.classList.toggle('active', show);
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && langPanel.classList.contains('show')){
        langPanel.classList.remove('show'); langPanel.setAttribute('aria-hidden','true'); navLanguage.classList.remove('active');
      }
    });
    document.getElementById('btn-pl')?.addEventListener('click', ()=>{ applyI18n('pl'); langPanel.classList.remove('show'); navLanguage.classList.remove('active'); });
    document.getElementById('btn-en')?.addEventListener('click', ()=>{ applyI18n('en'); langPanel.classList.remove('show'); navLanguage.classList.remove('active'); });

    // ----------------------------------------------
    // Login / Account / Paywall modals (mock)
    // ----------------------------------------------
    function openModal(sel){ const m=$(sel); if(!m) return; m.classList.add('show'); m.setAttribute('aria-hidden','false'); }
    function closeModal(sel){ const m=$(sel); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

    // Login
    on($('#nav-login'),'click',(e)=>{ e.preventDefault(); openModal('#loginModal'); });
    on($('#loginCancel'),'click',()=> closeModal('#loginModal'));
    

    // Account
    on($('#nav-account'),'click',(e)=>{
      e.preventDefault();
      $('#accountEmail').textContent = AUTH.email();
      $('#accountPlan').textContent = AUTH.isLoggedIn() ? 'Plan: Pro (mock)' : 'Plan: Free';
      openModal('#accountModal');
    });
    on($('#accountClose'),'click',()=> closeModal('#accountModal'));
    on($('#openPortal'),'click',async ()=>{
      // TODO: replace with call to your Cloud Function -> Stripe Customer Portal URL
      alert('Stripe Customer Portal (stub). Podmień na realny endpoint.');
    });

    // Sign out
    on($('#nav-signout'),'click',(e)=>{ e.preventDefault(); AUTH.logout(); });

    // Paywall
    on($('#paywallClose'),'click',()=> closeModal('#paywallModal'));
    on($('#subscribeStripe'),'click',async ()=>{
      // TODO: fetch('/billing/stripe/create-checkout', {method:'POST', credentials:'include'})
      alert('Stripe Checkout (stub). Podmień na realny endpoint.');
    });
    on($('#subscribePayPal'),'click',async ()=>{
      // TODO: fetch('/billing/paypal/create-subscription', {method:'POST', credentials:'include'})
      alert('PayPal Subscriptions (stub). Podmień na realny endpoint.');
    });

    // Settings
on($('#nav-settings'),'click',(e)=>{
  e.preventDefault();
  // wypełnij dane w modal-u settings (np. email, plan)
  $('#settingsEmail').textContent = AUTH.email();
  $('#settingsPlan').textContent  = AUTH.isLoggedIn() ? 'Plan: Pro (mock)' : 'Plan: Free';
  openModal('#settingsModal');
});
on($('#settingsClose'),'click',()=> closeModal('#settingsModal'));
on($('#deleteAccount'),'click',async ()=>{
  // TODO: podmień na realne usuwanie konta (Firebase)
  alert('Delete account (stub) – tu wywołaj deleteUser(auth.currentUser)');
});

// DEV panel – działa tylko z ?dev=1
(function setupDevPanel(){
  const showDev = params.get('dev') === '1';
  const panel = document.getElementById('dev-panel');
  if (panel) panel.style.display = showDev ? 'flex' : 'none';

  // DEV: wyczerp limit (ustawia plan Free, used=quota, reset za 60s)
  on(document.getElementById('dev-exhaust'), 'click', () => {
    localStorage.setItem('syntri.plan','Free'); // zapewnia skończoną quotę
    const u = getUsage();                       // { used, quota, resetAt }
    const exhausted = { ...u, used: u.quota, resetAt: Date.now() + 60_000 };
    saveUsage(exhausted);
    renderUsagePill();                          // odświeża pill + ensureHomeGate()
    alert('DEV: quota wyczerpana na 60s (Free plan).');
  });

  // DEV: reset limitu (used=0, resetAt -> początek następnego miesiąca)
  on(document.getElementById('dev-reset'), 'click', () => {
    const u = getUsage();
    const reset = { ...u, used: 0, resetAt: monthResetAtMs() };
    saveUsage(reset);
    renderUsagePill();
    alert('DEV: quota zresetowana.');
  });
})();
    
    // ----------------------------------------------
    // i18n
    // ----------------------------------------------
    const I18N = {
      pl: {
        title:'Syntri • Generator QR',
        nav_login:'Zaloguj', nav_account:'Konto', nav_signout:'Wyloguj', nav_language:'Język',
        label_text:'Treść (URL / tekst)', label_size:'Rozmiar (px)', label_ecc:'Korekcja błędów',
        label_margin:'Margines', label_color:'Kolor kodu', label_transparent:'Przezroczyste tło',
        btn_generate:'Generuj', btn_clear:'Wyczyść', btn_png:'Pobierz PNG', btn_svg:'Pobierz SVG',
        btn_copy:'Kopiuj link', btn_close:'Zamknij', link_share:'Udostępnij',
        note_offline:'Działa lokalnie w przeglądarce — żadne dane nie opuszczają urządzenia.',
        hint_hotkey:'— szybkie generowanie', alert_generate_first:'Najpierw wygeneruj QR', copied:'Skopiowano',
        modal_title:'It’s your QR code', modal_sub:'Generator by Syntri', modal_hint:'Budowanie pikseli…',
        login_title:'Logowanie', login_email_label:'Email', btn_login:'Zaloguj', btn_cancel:'Anuluj',
        account_title:'Konto',
        btn_manage_billing:'Zarządzaj subskrypcją',
        paywall_title:'Wyczerpano limit darmowy',
        paywall_copy:'Wykorzystałeś/aś wszystkie darmowe kody w tym miesiącu. Wybierz plan, aby kontynuować.'
      },
      en: {
        title:'Syntri • QR Generator',
        nav_login:'Login', nav_account:'Account', nav_signout:'Sign out', nav_language:'Language',
        label_text:'Content (URL / text)', label_size:'Size (px)', label_ecc:'Error correction',
        label_margin:'Margin', label_color:'Code color', label_transparent:'Transparent background',
        btn_generate:'Generate', btn_clear:'Clear', btn_png:'Download PNG', btn_svg:'Download SVG',
        btn_copy:'Copy link', btn_close:'Close', link_share:'Share',
        note_offline:'Runs locally in your browser — no data leaves your device.',
        hint_hotkey:'— quick generate', alert_generate_first:'Generate the QR first', copied:'Copied',
        modal_title:'It’s your QR code', modal_sub:'Generator by Syntri', modal_hint:'Building pixels…',
        login_title:'Log in', login_email_label:'Email', btn_login:'Log in', btn_cancel:'Cancel',
        account_title:'Account',
        btn_manage_billing:'Manage billing',
        paywall_title:'Free limit reached',
        paywall_copy:'You used all free codes this month. Choose a plan to continue.'
      }
    };
    function i18n(k){ const lang = localStorage.getItem('syntri.lang') || 'pl'; return (I18N[lang]||I18N.en)[k] || k; }
    const userLang = localStorage.getItem('syntri.lang') || ((navigator.language || 'en').startsWith('pl') ? 'pl' : 'en');
    function applyI18n(lang){
      const dict = I18N[lang] || I18N.en;
      document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (dict[key]) el.textContent = dict[key]; });
      const textInput = document.getElementById('text'); if (textInput) textInput.placeholder = lang==='pl' ? 'https://przyklad.pl' : 'https://example.com';
      localStorage.setItem('syntri.lang', lang);
      renderAuthUI();
    }
    document.getElementById('btn-pl')?.addEventListener('click', ()=>{ applyI18n('pl'); langPanel.classList.remove('show'); navLanguage.classList.remove('active'); });
    document.getElementById('btn-en')?.addEventListener('click', ()=>{ applyI18n('en'); langPanel.classList.remove('show'); navLanguage.classList.remove('active'); });
    applyI18n(userLang);
  </script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendPasswordResetEmail,
  signOut,
  onAuthStateChanged,
  updateProfile
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

/* === 1) KONFIGURACJA Firebase (ta sama co w konsoli projektu) === */
const firebaseConfig = {
  apiKey: "AIzaSyCN4mFs-l3SVfLGSiqOeSObenSPgQlx2XU",
  authDomain: "syntri-qr-generator.firebaseapp.com",
  projectId: "syntri-qr-generator",
  storageBucket: "syntri-qr-generator.appspot.com",
  messagingSenderId: "535838079759",
  appId: "1:535838079759:web:865ddfaee615280b645c7a",
  measurementId: "G-D1V72QVK11"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* === 2) Pomocnicze === */
const $ = (s) => document.querySelector(s);
function closeModal(sel){
  const m = $(sel);
  if (!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden','true');
}
function setBusy(el, busy){
  if (!el) return;
  el.disabled = !!busy;
  el.setAttribute('aria-busy', busy ? 'true':'false');
}

/* === 3) Rejestracja === */
$('#btnRegister')?.addEventListener('click', async () => {
  const btn   = $('#btnRegister');
  const email = ($('#loginEmail')?.value || '').trim();
  const pass  = ($('#loginPass')?.value  || '').trim();

  if (!email || !pass){ alert('Podaj email i hasło.'); return; }
  if (pass.length < 6){ alert('Hasło musi mieć min. 6 znaków.'); return; }

  try {
    setBusy(btn, true);
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // (opcjonalnie) ustaw nazwę z części e-maila
    const name = email.split('@')[0].slice(0, 32);
    try { await updateProfile(cred.user, { displayName: name }); } catch {}
    alert('Konto utworzone i zalogowano: ' + (cred.user.email || email));
    closeModal('#loginModal');
  } catch (err) {
    console.error(err);
    // Najczęstsze: auth/email-already-in-use, auth/invalid-email, auth/weak-password
    alert('Rejestracja nieudana: ' + (err?.code || err?.message || err));
  } finally {
    setBusy(btn, false);
  }
});

/* === 4) Logowanie === */
$('#btnLogin')?.addEventListener('click', async () => {
  const btn   = $('#btnLogin');
  const email = ($('#loginEmail')?.value || '').trim();
  const pass  = ($('#loginPass')?.value  || '').trim();

  if (!email || !pass){ alert('Podaj email i hasło.'); return; }

  try {
    setBusy(btn, true);
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    alert('Zalogowano jako: ' + (cred.user.email || email));
    closeModal('#loginModal');
  } catch (err) {
    console.error(err);
    // Najczęstsze: auth/user-not-found, auth/wrong-password
    alert('Logowanie nieudane: ' + (err?.code || err?.message || err));
  } finally {
    setBusy(btn, false);
  }
});

/* === 5) Reset hasła (Forgot password) – z własną stroną resetu === */
$('#btnForgot')?.addEventListener('click', async () => {
  const btn   = $('#btnForgot');
  const email = ($('#loginEmail')?.value || '').trim();
  if (!email) {
    alert('Podaj adres e-mail, aby zresetować hasło.');
    return;
  }

  try {
    setBusy(btn, true);

    // >>> TU podaj adres swojej strony resetu hasła:
    // Plik reset.html musi być wdrożony w Firebase Hosting
    const actionCodeSettings = {
      url: 'https://syntri-qr-generator.web.app/reset.html',
      handleCodeInApp: true
    };

    await sendPasswordResetEmail(auth, email, actionCodeSettings);
    alert('Wysłaliśmy link resetu hasła na: ' + email);
  } catch (err) {
    console.error(err);
    // Typowe błędy: auth/user-not-found, auth/invalid-email
    alert('Nie udało się wysłać resetu: ' + (err?.code || err?.message || err));
  } finally {
    setBusy(btn, false);
  }
});

/* === 6) Wylogowanie (link w nawigacji) === */
$('#nav-signout')?.addEventListener('click', async (e) => {
  e.preventDefault();
  const link = $('#nav-signout');
  try {
    setBusy(link, true);
    await signOut(auth);
    alert('Wylogowano.');
  } catch (err) {
    console.error(err);
    alert('Błąd wylogowania: ' + (err?.code || err?.message || err));
  } finally {
    setBusy(link, false);
  }
});

/* === 7) Synchronizacja z Twoim istniejącym UI / localStorage === */
onAuthStateChanged(auth, (user) => {
  if (user) {
    localStorage.setItem('syntri.auth.uid',   user.uid);
    localStorage.setItem('syntri.auth.email', user.email || '');
  } else {
    localStorage.removeItem('syntri.auth.uid');
    localStorage.removeItem('syntri.auth.email');
  }
  if (typeof renderAuthUI === 'function') renderAuthUI();
});
</script>

</body>
</html>

